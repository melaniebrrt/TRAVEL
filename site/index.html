<script>
// --- Helpers ---
function normalizeText(str){ return str ? String(str).trim() : ''; }
function formatDateDynamic(event){
    const start = event.DateTime_start ? new Date(event.DateTime_start) : null;
    const end = event.DateTime_end ? new Date(event.DateTime_end) : null;
    if(!start) return 'Non indiquée';
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    if(!end || start.getTime()===end.getTime()) return start.toLocaleDateString('fr-FR', options);
    if(start.getFullYear()===end.getFullYear() && start.getMonth()===end.getMonth()){
        return `${start.getDate()}–${end.getDate()} ${start.toLocaleDateString('fr-FR',{month:'long', year:'numeric'})}`;
    }
    if(start.getFullYear()===end.getFullYear()){
        return `${start.toLocaleDateString('fr-FR',{day:'numeric', month:'long'})} – ${end.toLocaleDateString('fr-FR',{day:'numeric', month:'long', year:'numeric'})}`;
    }
    return `${start.toLocaleDateString('fr-FR',options)} – ${end.toLocaleDateString('fr-FR',options)}`;
}

// --- Map init ---
const map = L.map('map').setView([46.603354,1.888334],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

// --- Elements ---
const interestSelect = document.getElementById('interest-select');
const searchInput = document.getElementById('search-input');
const searchButton = document.getElementById('search-button');
const eventListContainer = document.getElementById('event-list-container');
const cityResultsContainer = document.getElementById('city-results-container');
const dateStartInput = document.getElementById('date-start');
const dateEndInput = document.getElementById('date-end');
const sortButton = document.getElementById('sort-date-button');
let sortByDate = false;

// --- Events ---
sortButton.addEventListener('click', ()=>{
    sortByDate = !sortByDate;
    sortButton.textContent = sortByDate ? 'Trier: Date ↑' : 'Trier';
    searchEvents();
});

searchButton.addEventListener('click', searchEvents);
searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchEvents(); });

// --- Load categories ---
fetch('/api/categories').then(r=>r.json()).then(list=>{
    interestSelect.innerHTML = '<option value="">-- Tous --</option>';
    list.forEach(c=>{
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        interestSelect.appendChild(o);
    });
});

// --- Create Event Card ---
function createEventCard(e){
    const wrap = document.createElement('div');
    wrap.className='event-card';

    const meta = document.createElement('div');
    meta.className='meta';
    meta.innerHTML = `<div class="small">${formatDateDynamic(e)}</div><div class="small">${e.City||'N/A'}</div>`;

    const body = document.createElement('div'); body.style.flex='1';
    const title = document.createElement('h3'); title.textContent = e.EventName||'Sans titre';
    const desc = document.createElement('p'); desc.textContent = e.Description? (e.Description.length>180? e.Description.slice(0,180)+'…':e.Description) : 'Pas de description.';
    const tags = document.createElement('div'); tags.className='tags';
    if(e.Category) { const t=document.createElement('span'); t.className='tag'; t.textContent=e.Category; tags.appendChild(t); } 
    const link = document.createElement('a'); link.href = e.Link||'#'; link.target='_blank'; link.className='small'; link.style.display='inline-block'; link.style.marginTop='8px'; link.textContent='Voir la source ↗';
    body.appendChild(title); body.appendChild(desc); body.appendChild(tags); body.appendChild(link);

    wrap.appendChild(meta); wrap.appendChild(body);
    return wrap;
}

// --- Search function ---
function searchEvents(){
    const interest = interestSelect.value.trim();
    const query = searchInput.value.trim();
    const startDate = dateStartInput.value;
    const endDate = dateEndInput.value;

    let urlEvents = `/api/smart-search?`;
    if(interest) urlEvents += `interests=${encodeURIComponent(interest)}&`;
    if(query) urlEvents += `q=${encodeURIComponent(query)}&`;
    if(startDate) urlEvents += `start_date=${encodeURIComponent(startDate)}&`;
    if(endDate) urlEvents += `end_date=${encodeURIComponent(endDate)}&`;
    if(sortByDate) urlEvents += `sort=date`;

    fetch(urlEvents).then(r=>r.json()).then(events=>{
        eventListContainer.innerHTML=''; 
        markersLayer.clearLayers();
        if(!events || !events.length){
            eventListContainer.innerHTML='<div class="small">Aucun événement trouvé.</div>';
            cityResultsContainer.innerHTML='<div class="small">-</div>';
            return;
        }

        events.slice(0,60).forEach(ev=>{
            eventListContainer.appendChild(createEventCard(ev));
            if(ev.lat && ev.lon){
                const m = L.marker([ev.lat, ev.lon]).addTo(markersLayer);
                m.bindPopup(`<strong>${ev.EventName||'Sans titre'}</strong><br>${ev.Category||''}<br>${ev.City||''}<br>${formatDateDynamic(ev)}<br><a href='${ev.Link||'#'}' target='_blank'>Voir ↗</a>`);
            }
        });

        if(markersLayer.getLayers().length) map.fitBounds(markersLayer.getBounds().pad(0.15));
    });

    // --- Cities ---
    let urlCities = `/api/cities-by-llm?`;
    if(interest) urlCities += `interests=${encodeURIComponent(interest)}&`;
    if(query) urlCities += `q=${encodeURIComponent(query)}&`;
    if(startDate) urlCities += `start_date=${encodeURIComponent(startDate)}&`;
    if(endDate) urlCities += `end_date=${encodeURIComponent(endDate)}&`;

    fetch(urlCities).then(r=>r.json()).then(cities=>{
        cityResultsContainer.innerHTML='';
        if(!cities || !cities.length){
            cityResultsContainer.innerHTML='<div class="small">Aucune ville trouvée.</div>';
            return;
        }
        cities.slice(0,8).forEach(c=>{
            const d=document.createElement('div');
            d.className='city-pill';
            d.innerHTML = `<span>${c.City}</span><span class='small'>${c.count}</span>`;
            cityResultsContainer.appendChild(d);
        });
    });
}

// --- Initial load ---
searchEvents();
</script>


